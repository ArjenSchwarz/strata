# Strata Composite GitHub Action Plan

## Overview
Create a composite GitHub Action that allows other repositories to use Strata for Terraform plan analysis in their CI/CD pipelines. The action will output results to both GitHub step summaries and PR comments.

## Action Structure

### Files Required
- `action.yml` - Action metadata and interface
- `action.sh` - Main execution script
- Documentation updates for usage

### Action Inputs
```yaml
inputs:
  plan-file:
    description: 'Path to Terraform plan file'
    required: true
  output-format:
    description: 'Output format (table, json, markdown)'
    required: false
    default: 'markdown'
  config-file:
    description: 'Path to custom Strata config file'
    required: false
  danger-threshold:
    description: 'Danger threshold for highlighting risks'
    required: false
  show-details:
    description: 'Show detailed change information'
    required: false
    default: 'false'
  github-token:
    description: 'GitHub token for PR comments'
    required: false
    default: ${{ github.token }}
  comment-on-pr:
    description: 'Whether to comment on PR'
    required: false
    default: 'true'
```

### Action Outputs
```yaml
outputs:
  summary:
    description: 'Plan summary text'
  has-changes:
    description: 'Whether the plan contains changes'
  has-dangers:
    description: 'Whether dangerous changes were detected'
  json-summary:
    description: 'Full summary in JSON format'
```

## Implementation Steps

### 1. Binary Distribution Strategy
- **Option A**: Download pre-built binary from GitHub releases
- **Option B**: Build from source during action run
- **Recommended**: Option A for speed, with fallback to Option B

### 2. Step Summary Integration
- Use `$GITHUB_STEP_SUMMARY` to append markdown output
- Include collapsible sections for detailed information
- Add visual indicators for dangerous changes

### 3. PR Comment Integration
- Check if running in PR context (`github.event_name == 'pull_request'`)
- Use GitHub API to post/update comments
- Implement comment management:
  - Search for existing Strata comments
  - Update existing rather than creating new
  - Use unique comment identifier

### 4. Error Handling
- Validate plan file exists and is readable
- Handle Strata execution errors gracefully
- Provide clear error messages in outputs

### 5. Permission Requirements
Users will need to set appropriate permissions in their workflows:
```yaml
permissions:
  contents: read
  pull-requests: write  # For PR comments
```

## Action Script Logic Flow

```bash
#!/bin/bash
set -e

# 1. Validate inputs
# 2. Download/install Strata binary
# 3. Run Strata with provided parameters
# 4. Capture output and parse results
# 5. Write to step summary
# 6. If PR context and enabled, post/update PR comment
# 7. Set action outputs
```

## Usage Examples

### Basic Usage
```yaml
- uses: ArjenSchwarz/strata@v1
  with:
    plan-file: terraform.tfplan
```

### Advanced Usage
```yaml
- uses: ArjenSchwarz/strata@v1
  with:
    plan-file: terraform.tfplan
    output-format: markdown
    danger-threshold: 5
    show-details: true
    config-file: .strata.yaml
    github-token: ${{ secrets.GITHUB_TOKEN }}
```

### Complete Workflow Example
```yaml
name: Terraform Plan Analysis
on:
  pull_request:
    paths: ['**.tf', '**.tfvars']

permissions:
  contents: read
  pull-requests: write

jobs:
  plan-analysis:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      
    - name: Terraform Plan
      run: terraform plan -out=terraform.tfplan
      
    - name: Analyze Plan with Strata
      uses: ArjenSchwarz/strata@v1
      with:
        plan-file: terraform.tfplan
        show-details: true
```

## PR Comment Template

```markdown
## üèóÔ∏è Terraform Plan Summary

<!-- strata-comment-id: unique-identifier -->

**Plan Summary:**
{summary-table}

**Statistics:**
- üìù **Changes**: {total-changes}
- ‚ö†Ô∏è **Dangerous**: {dangerous-changes}
- üîÑ **Replacements**: {replacements}

<details>
<summary>üìã Detailed Changes</summary>

{detailed-changes}

</details>

---
*Generated by [Strata](https://github.com/ArjenSchwarz/strata)*
```

## Distribution Strategy

### Release Process
1. Tag releases with semantic versioning
2. Provide major version tags (v1, v2) for easy consumption
3. Include action in GitHub Marketplace

### Documentation
- Update main README with action usage
- Create separate action documentation
- Provide example workflows

## Testing Strategy

### Unit Testing
- Test action script components
- Mock GitHub API interactions
- Test different input combinations

### Integration Testing
- Test with real Terraform plans
- Test PR and push contexts
- Test permission scenarios

### Example Repository
- Create example repository demonstrating usage
- Include various Terraform scenarios
- Document best practices

## Security Considerations

### Token Usage
- Use provided `github.token` by default
- Support custom tokens for enhanced permissions
- Validate token has required permissions

### Input Validation
- Sanitize file paths
- Validate plan file format
- Prevent command injection

### Output Security
- Avoid exposing sensitive information in comments
- Implement output size limits
- Handle binary/non-text plan files safely

## Future Enhancements

### V1 Scope
- Basic plan analysis and commenting
- Step summary integration
- Standard input/output handling

### Future Versions
- Multi-plan analysis support
- Custom comment templates
- Integration with other tools (Infracost, etc.)
- Slack/Teams notifications
- Policy-as-code integration