# Strata

![Strata logo](docs/images/strata-logo.jpg)

Strata is a CLI tool to enhance your Terraform workflows with clear, concise summaries of plan changes. It doesn't modify your Terraform workflow or require any special configuration - it simply provides better visibility into what your Terraform plans will do, helping you make more informed decisions before applying changes.

## Features

### Version Information

Strata provides version information through both a global flag and a dedicated command:

```shell
# Quick version check
$ strata --version
strata version 1.0.0

# Detailed version information
$ strata version
strata version 1.0.0
Built: 2025-01-24T10:30:00Z
Commit: f2a261e
Go: go1.24.1

# JSON output for scripts
$ strata version --output json
{
  "version": "1.0.0",
  "build_time": "2025-01-24T10:30:00Z",
  "git_commit": "f2a261e",
  "go_version": "go1.24.1"
}
```

### Plan Summaries

The main functionality of Strata is to generate comprehensive summaries of Terraform plan files. You can create a summary using the `strata plan summary` command. For detailed help on this and other commands, add the `--help` flag.

```shell
$ strata plan summary --help

Summarize a Terraform plan file

This command analyzes a Terraform plan file and provides a summary of the changes.
It can read both binary plan files and JSON plan files (from terraform show -json).

The summary includes:
- Plan information (Terraform version, workspace, backend)
- Statistical overview of changes (additions, modifications, deletions, replacements)
- Detailed resource changes with IDs and module information
- Highlighting of potentially dangerous changes
- Progressive disclosure with collapsible sections for comprehensive details
- Provider grouping for large plans (when enabled)
- Risk analysis with automatic expansion of high-risk changes

Progressive Disclosure Features:
The enhanced summary visualization provides collapsible sections that allow you to:
- See essential information (resource name, change type, risk level) by default
- Expand sections to view all property changes (no longer limited to 3)
- Access detailed risk analysis and mitigation suggestions
- View resource dependencies and relationships  
- Group resources by provider when working with large plans

Global Expand Control:
Use the --expand-all flag to expand all collapsible sections at once:
  strata plan summary --expand-all terraform.tfplan

Provider Grouping:
Large plans are automatically grouped by provider for better organization:
- Only groups when resource count meets threshold (default: 10)  
- Skips grouping if all resources are from the same provider
- High-risk provider groups are auto-expanded

File Output:
The --file and --file-format flags allow you to save output to a file in addition
to displaying it on stdout. The file format can be different from the stdout format.
File paths support placeholders for dynamic naming:
  $TIMESTAMP     - Current timestamp (2006-01-02T15-04-05 format)
  $AWS_REGION    - AWS region from context
  $AWS_ACCOUNTID - AWS account ID from context

Examples:
  strata plan summary terraform.tfplan
  strata plan summary --output json terraform.tfplan
  strata plan summary --show-details terraform.tfplan
  strata plan summary --expand-all terraform.tfplan
  strata plan summary --file output.json --file-format json terraform.tfplan
  strata plan summary --file "report-$TIMESTAMP-$AWS_REGION.md" --file-format markdown terraform.tfplan

Usage:
  strata plan summary [flags] PLAN_FILE

Flags:
  -e, --expand-all             Expand all collapsible sections
  -h, --help                   help for summary
      --highlight-dangers      Highlight potentially dangerous changes (default true)
      --show-details           Show detailed resource changes (default true)
      --show-statistics        Show statistics summary table (default true)
      --stats-format string    Statistics summary format (horizontal, vertical) (default "horizontal")

Global Flags:
      --config string          config file (default is ./strata.yaml or ~/.strata.yaml)
      --debug                  Enable debug output
      --file string            Optional file to save the output to, in addition to stdout
      --file-format string     Optional format for the file, defaults to the same as output
  -v, --verbose                Enable verbose output
```

Strata assumes that you're providing a valid Terraform plan file, either in binary format (as generated by `terraform plan -out=file.tfplan`) or in JSON format (as generated by `terraform show -json file.tfplan > plan.json`).

### Usage

An example for generating a plan summary would be:

```shell
$ strata plan summary terraform.tfplan
```

This will analyze the plan file and display a comprehensive summary with the following sections:

1. **Plan Information** - Details about the plan file, Terraform version, workspace, and backend
2. **Statistics Summary** - Counts of resources being added, modified, deleted, or replaced
3. **Resource Changes** - Detailed table of all resource changes with IDs and module information
4. **Progressive Disclosure** - Collapsible sections for property changes, dependencies, and risk analysis
5. **Provider Grouping** - Smart grouping by provider for large plans (when threshold is met)
6. **Danger Highlights** - Warning indicators for potentially risky changes with auto-expansion

### Enhanced Summary Features

#### Progressive Disclosure
The enhanced summary visualization uses collapsible sections to provide comprehensive information without overwhelming the primary view:

- **Clean Overview**: Essential information (resource name, change type, risk level) shown by default
- **Expandable Details**: Click or configure to expand for complete property changes, dependencies, and risk analysis
- **No Property Limits**: All property changes are now captured (no longer limited to 3)
- **Auto-Expansion**: High-risk changes and sensitive properties automatically expand for immediate visibility

#### Provider Grouping
For large plans with multiple providers, Strata automatically organizes resources:

```shell
# Example output with provider grouping
AWS Provider (8 changes)
  ├── aws_instance.web (replace) - ⚠️ critical
  ├── aws_security_group.web (update) - low
  └── aws_rds_db_instance.main (replace) - ⚠️ critical

AZURERM Provider (3 changes)
  ├── azurerm_virtual_machine.app (create) - low
  └── azurerm_storage_account.data (update) - medium
```

- **Smart Thresholds**: Only groups when resource count ≥ 10 and multiple providers present
- **Auto-Expansion**: Provider groups with high-risk changes expand automatically
- **Configurable**: Can be disabled or threshold adjusted in `strata.yaml`

#### Global Expand Control
Use the `--expand-all` flag for complete visibility:

```shell
# Expand all collapsible sections for full details
$ strata plan summary --expand-all terraform.tfplan

# Can also be configured in strata.yaml
$ cat strata.yaml
expand_all: true
```

![](docs/images/strata-plan-summary.jpg)

### Output Formats

Strata supports multiple output formats to fit different use cases:

```shell
# Generate summary in JSON format
$ strata plan summary --output json terraform.tfplan

# Generate HTML report and save to file
$ strata plan summary --output html --file report.html terraform.tfplan

# Generate markdown output for documentation with collapsible sections
$ strata plan summary --output markdown terraform.tfplan

# Generate table output with danger highlighting and expanded details
$ strata plan summary --highlight-dangers --expand-all terraform.tfplan

# Generate markdown with provider grouping for large plans
$ strata plan summary --output markdown --expand-all terraform.tfplan
```

#### Cross-Format Collapsible Content

The enhanced summary visualization adapts collapsible content to each output format:

| Format   | Collapsible Behavior | Best Use Case |
|----------|---------------------|---------------|
| **Markdown** | Uses `<details>` elements for interactive expansion | GitHub PRs, documentation |
| **HTML** | JavaScript-powered expandable sections | Web reports, dashboards |
| **Table** | Shows summary with expansion indicators | Terminal output, quick scanning |
| **JSON** | Full structured data with all details | API integration, programmatic access |

### File Output

Strata provides flexible file output capabilities that allow you to save formatted output to files while simultaneously displaying results on stdout. This is particularly useful for generating reports, documentation, or integrating with CI/CD pipelines.

#### Basic File Output

```shell
# Save table output to file (same format as stdout)
$ strata plan summary --file output.txt terraform.tfplan

# Save as JSON while displaying table on stdout
$ strata plan summary --file output.json --file-format json terraform.tfplan

# Save as HTML report with custom formatting
$ strata plan summary --output table --file report.html --file-format html terraform.tfplan

# Generate markdown documentation
$ strata plan summary --file documentation.md --file-format markdown terraform.tfplan
```

#### Dynamic File Naming with Placeholders

File paths support placeholders for dynamic naming, making it easy to organize outputs by context:

```shell
# Use timestamp in filename
$ strata plan summary --file "report-$TIMESTAMP.json" --file-format json terraform.tfplan

# Include AWS context in filename
$ strata plan summary --file "$AWS_REGION-$AWS_ACCOUNTID-plan.md" --file-format markdown terraform.tfplan

# Comprehensive naming with timestamp and region
$ strata plan summary --file "reports/$AWS_REGION-$TIMESTAMP.html" --file-format html terraform.tfplan
```

**Available Placeholders:**
- `$TIMESTAMP` - Current timestamp in format `2006-01-02T15-04-05`
- `$AWS_REGION` - AWS region from context
- `$AWS_ACCOUNTID` - AWS account ID from context

#### File Output Examples

```shell
# CI/CD Integration - Save JSON for further processing
$ strata plan summary --output table --file "artifacts/plan-$TIMESTAMP.json" --file-format json terraform.tfplan

# Documentation Generation - Create markdown reports
$ strata plan summary --file "docs/infrastructure-changes-$TIMESTAMP.md" --file-format markdown terraform.tfplan

# Multi-format Output - Table for console, HTML for sharing
$ strata plan summary --output table --file "reports/plan-summary.html" --file-format html terraform.tfplan

# Organized Reports - Use placeholders for systematic filing
$ strata plan summary --file "reports/$AWS_REGION/plan-$TIMESTAMP.json" --file-format json terraform.tfplan
```

#### File Output Features

- **Dual Output**: Simultaneously write to stdout and file with different formats
- **Format Flexibility**: File format can differ from stdout format
- **Placeholder Support**: Dynamic file naming with contextual information
- **Path Validation**: Automatic validation of file paths and permissions
- **Security**: Built-in protection against path traversal attacks
- **Error Handling**: Graceful degradation if file writing fails

### Danger Highlights

Strata automatically identifies and highlights potentially dangerous changes in your Terraform plans:

1. **Destructive Changes** - Resources being deleted or replaced
2. **Sensitive Resource Replacements** - Replacement of critical infrastructure components
3. **Sensitive Property Changes** - Modifications to properties that might cause service disruptions
4. **High-Risk Changes** - Sensitive resources with danger flags are counted separately in the statistics summary
5. **Action Sorting** - Dangerous changes are automatically sorted to appear first (Remove > Replace > Modify > Add)

You can configure which resources and properties are considered sensitive in your `strata.yaml` configuration file:

```yaml
sensitive_resources:
  - resource_type: aws_db_instance
  - resource_type: aws_ec2_instance
sensitive_properties:
  - resource_type: aws_instance
    property: user_data
```

When a sensitive resource is being replaced or a sensitive property is being modified, Strata will highlight it with a warning indicator (⚠️) and provide details about why the change is considered dangerous. The warning system now shows warnings for any destructive changes without requiring threshold configuration.

## Configuration

You can customize Strata's behavior using a configuration file. Strata will look for a file named `strata.yaml` in the current directory or your home directory, or you can specify a custom file using the `--config` flag.

Example configuration:

```yaml
# Global expand control for collapsible sections
expand_all: false                    # Expand all collapsible sections (default: false)

output: table
table:
  style: ColoredBlackOnMagentaWhite

plan:
  show-details: true
  highlight-dangers: true
  always-show-sensitive: true        # Always show sensitive resources even when details are disabled
  
  # Enhanced summary visualization settings
  expandable_sections:
    enabled: true                    # Enable collapsible sections (default: true)
    auto_expand_dangerous: true      # Auto-expand high-risk sections (default: true)
    show_dependencies: true          # Show dependency information (default: true)
  
  grouping:
    enabled: true                    # Enable provider grouping (default: true)  
    threshold: 10                    # Minimum resources to trigger grouping (default: 10)

# File output configuration
output-file: "reports/plan-$TIMESTAMP.json"  # Default file output path with placeholder
output-file-format: json                     # Default file format

# Sensitive resources and properties configuration
sensitive_resources:
  - resource_type: aws_db_instance
  - resource_type: aws_ec2_instance
sensitive_properties:
  - resource_type: aws_instance
    property: user_data
```

## GitHub Action

Strata is available as a GitHub Action that can be easily integrated into your CI/CD workflows. The action automatically analyzes Terraform plans and provides summaries in GitHub step summaries and pull request comments.

### Basic Usage

```yaml
- name: Analyze Terraform Plan
  uses: ArjenSchwarz/strata@v1
  with:
    plan-file: terraform.tfplan
```

### Advanced Usage

```yaml
- name: Analyze Terraform Plan
  uses: ArjenSchwarz/strata@v1
  with:
    plan-file: terraform.tfplan
    output-format: markdown
    show-details: true
    highlight-dangers: true
    expand-all: false              # Set to true to expand all collapsible sections in PR comments
    config-file: .strata.yaml
    comment-on-pr: true
    update-comment: true
    comment-header: "🏗️ Infrastructure Changes"
```

### Required Permissions

**IMPORTANT:** For the GitHub Action to post comments on pull requests, you must configure the proper permissions in your workflow:

```yaml
permissions:
  contents: read
  pull-requests: write  # Required for commenting on PRs
  issues: write         # Required for issue comments (PRs are issues)
```

### Complete Workflow Example

```yaml
name: Terraform Plan Analysis
on:
  pull_request:
    paths: ['**.tf', '**.tfvars']

# REQUIRED: These permissions are needed for PR comments
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  plan-analysis:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      
    - name: Terraform Plan
      run: terraform plan -out=terraform.tfplan
      
    - name: Analyze Plan with Strata
      uses: ArjenSchwarz/strata@v1
      with:
        plan-file: terraform.tfplan
        show-details: true
        github-token: ${{ secrets.GITHUB_TOKEN }}
```

### Action Inputs

| Input | Description | Required | Default |
|-------|-------------|----------|----------|
| `plan-file` | Path to Terraform plan file | Yes | |
| `output-format` | Output format (table, json, markdown) | No | `markdown` |
| `config-file` | Path to custom Strata config file | No | |
| `highlight-dangers` | Highlight potentially dangerous changes | No | `true` |
| `show-details` | Show detailed change information | No | `false` |
| `expand-all` | Expand all collapsible sections | No | `false` |
| `github-token` | GitHub token for PR comments | No | `${{ github.token }}` |
| `comment-on-pr` | Whether to comment on PR | No | `true` |
| `update-comment` | Whether to update existing comment | No | `true` |
| `comment-header` | Custom header for PR comments | No | `🏗️ Terraform Plan Summary` |

### Action Outputs

| Output | Description |
|--------|-------------|
| `summary` | Plan summary text |
| `has-changes` | Whether the plan contains changes |
| `has-dangers` | Whether dangerous changes were detected |
| `json-summary` | Full summary in JSON format |
| `change-count` | Total number of changes |
| `danger-count` | Number of dangerous changes |

### Features

- **Step Summary Integration**: Automatically adds rich Markdown summaries to GitHub step summaries
- **Pull Request Comments**: Posts or updates comments on pull requests with plan analysis
- **Progressive Disclosure**: Uses collapsible sections in PR comments for clean, expandable output
- **Multiple Output Formats**: Supports table, JSON, and Markdown output formats with cross-format collapsible content
- **Provider Grouping**: Automatically groups large plans by provider for better organization
- **Expand-All Control**: Global flag to expand all collapsible sections for complete visibility
- **Danger Detection**: Highlights potentially risky changes with sensitive resource and property detection
- **Auto-Expansion**: High-risk changes automatically expand in PR comments for immediate visibility
- **Caching**: Automatically caches Strata binaries for faster execution
- **Error Handling**: Graceful error handling with clear messaging

### GitHub Token Requirements

For the action to post comments on pull requests, your workflow must include the following permissions:

```yaml
permissions:
  contents: read
  pull-requests: write  # Required for commenting on PRs
  issues: write         # Required for issue comments (PRs are issues)
```

**Note:** The action uses the built-in `GITHUB_TOKEN` which is automatically provided by GitHub Actions. No additional token setup is required - just ensure the proper permissions are configured in your workflow.

## Installation

### Prerequisites
- Go 1.24.1 or higher
- Terraform 1.6+ (for testing)

### From Source

```bash
# Clone the repository
git clone https://github.com/ArjenSchwarz/strata.git
cd strata

# Build the project (includes version information)
make build

# Build with specific version
make build VERSION=1.0.0

# Build release version (requires VERSION parameter)
make build-release VERSION=1.0.0

# Install locally
go install
```

#### Manual Build with Version Information

If you prefer to build manually with version information:

```bash
# Build with version injection
go build -ldflags "-X github.com/ArjenSchwarz/strata/cmd.Version=1.0.0 \
                   -X github.com/ArjenSchwarz/strata/cmd.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
                   -X github.com/ArjenSchwarz/strata/cmd.GitCommit=$(git rev-parse --short HEAD)" .

# Check version
./strata --version
./strata version
./strata version --output json
```

### Using Go Install

```bash
go install github.com/ArjenSchwarz/strata@latest
```

## Development

Strata uses a standard Go project structure with the following components:

```
strata/
├── cmd/                  # Command-line interface definitions
├── config/               # Configuration management
├── docs/                 # Documentation
├── lib/                  # Core library code
│   └── plan/             # Terraform plan processing
├── main.go               # Application entry point
└── strata.yaml           # Default configuration file
```

### Building and Testing

```bash
# Build the project
make build

# Run tests
make test

# Run sample tests
make run-sample

# Run sample tests with detailed output
make run-sample-details
```

## What's New in v1.0

Strata v1.0 represents a major milestone with comprehensive Terraform plan analysis capabilities:

### Core Features
- **Complete Plan Analysis**: Full parsing and analysis of Terraform plans with change categorization
- **Multiple Output Formats**: Support for table, JSON, HTML, and Markdown formats
- **Danger Detection**: Automatic identification of potentially risky changes without manual thresholds
- **Action Sorting**: Prioritized display of changes by risk level (Remove > Replace > Modify > Add)

### Enhanced Summary Visualization
- **Progressive Disclosure**: Collapsible sections provide comprehensive information without overwhelming the primary view
- **No Property Limits**: All property changes are now captured and accessible (no longer limited to 3)
- **Provider Grouping**: Smart grouping by provider for large plans with configurable thresholds
- **Global Expand Control**: `--expand-all` flag to expand all collapsible sections at once
- **Auto-Expansion**: High-risk changes and sensitive properties automatically expand for immediate visibility
- **Cross-Format Adaptation**: Collapsible content adapts appropriately to each output format (Markdown, HTML, Table, JSON)

### Advanced Capabilities  
- **File Output System**: Dual output support with dynamic file naming using placeholders
- **GitHub Action Integration**: Seamless CI/CD integration with PR comments and step summaries
- **Enhanced GitHub Actions**: Support for `expand-all` parameter in GitHub Action workflows
- **Sensitive Resource Detection**: Configurable highlighting of critical infrastructure changes
- **Enhanced Statistics**: Horizontal statistics layout with comprehensive change tracking
- **Risk Analysis**: Automated risk assessment with detailed analysis and mitigation suggestions

### Technical Improvements
- **Go-Output v2**: Leverages latest output library with native collapsible content support
- **Performance Optimizations**: Memory limits, parallel processing, and efficient property analysis
- **Cross-Platform Binaries**: Automated releases for Linux, Windows, and macOS (amd64/arm64)
- **Version Management**: Built-in version information with build-time injection
- **Modular Architecture**: Clean separation of concerns for better maintainability
- **Comprehensive Testing**: Extensive test suite with performance benchmarks and edge case coverage

For a complete list of changes, see the [CHANGELOG.md](CHANGELOG.md).

## Contributions

If you wish to contribute in any way (reporting bugs, requesting features, writing code), feel free to do so either by opening Issues or Pull Requests. For Pull Requests, just follow the standard pattern:

1. Fork the repository
2. Make your changes
3. Make a pull request that explains what it does

## License

Strata is licensed under the MIT License.